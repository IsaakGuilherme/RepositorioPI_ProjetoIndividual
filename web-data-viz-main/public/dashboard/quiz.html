<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Santista</title>
  <link rel="stylesheet" href="../css/quiz.css">
  <link rel="icon" href="../assets/icon/Santos.ico">
  <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&display=swap" rel="stylesheet">
</head>

<body onload="onloadEsconder(), carregarQuestoes(), validarSessao()">
  <div class="quiz-header">
    <div class="container">
      <h1 class="titulo">Quiz do Santos</h1>
      <a href="index.html" class="btn-voltar">Voltar ao Início</a>
    </div>
  </div>

  <section class="quiz-main">
    <div class="container">
      <div class="quiz-box">

        <div class="quiz-iniciar" id="quiz-iniciar">
          <h2>Pronto para iniciar o quiz?</h2>
          <button onclick="iniciarQuiz()" id="btnIniciarQuiz">Indicar Quiz</button>
        </div>

        <div id="quiz-geral">
          <div class="quiz-pergunta">
            <h2>Pergunta <span id="spanNumeroDaQuestaoAtual"></span></h2>
            <p id="perguntaDaQuestaoAtual"><span id="spanQuestaoExibida"></span></p>
          </div>
          <div class="quiz-opcoes" id="quiz-opcoes">
            <span>
              <input type="radio" id="alternativaA" name="option" class="radio" value="alternativaA" />
              <label for="alternativaA" class="opcao" id="labelAlternativaA"></label>
            </span>
            <span>
              <input type="radio" id="alternativaB" name="option" class="radio" value="alternativaB" />
              <label for="alternativaB" class="opcao" id="labelAlternativaB"></label>
            </span>
            <span>
              <input type="radio" id="alternativaC" name="option" class="radio" value="alternativaC" />
              <label for="alternativaC" class="opcao" id="labelAlternativaC"></label>
            </span>
            <span>
              <input type="radio" id="alternativaD" name="option" class="radio" value="alternativaD" />
              <label for="alternativaD" class="opcao" id="labelAlternativaD"></label>
            </span>
          </div>
          <div class="quiz-progresso">
            <span>Pergunta <span id="spanNumeroDaQuestaoAtual2"></span> de <span id="qtdQuestoes"></span></span>
          </div>
          <div class="quiz-controle">
            <button class="btn-proximo" id="btn-proximo" onclick="avancar()">Próxima</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</body>

</html>

<script>
  let listaDeQuestoes = [];

  let numeroDaQuestaoAtual = 0
  let quantidadeDeQuestoes = listaDeQuestoes.length

  const btnSubmeter = document.getElementById('btnSubmeter');
  const btnProx = document.getElementById('btn-proximo');

  function onloadEsconder() {
    document.getElementById('quiz-geral').style.display = "none";
  }

  function carregarQuestoes() {
    fetch("/quiz/buscar")
      .then(response => response.json())
      .then(data => {
        listaDeQuestoes = data;
        quantidadeDeQuestoes = listaDeQuestoes.length;

        if (quantidadeDeQuestoes > 0) {
          document.getElementById('btnIniciarQuiz').style.display = "block";
        } else {
          alert("Nenhuma questão disponível para o quiz.");
        }
      })
      .catch(error => {
        console.error("Erro ao carregar as questões:", error);
      });
  }

  function iniciarQuiz() {
    document.getElementById('quiz-geral').style.display = "block";
    document.getElementById('quiz-iniciar').style.display = "none";
    document.getElementById('btnIniciarQuiz').style.display = "none";

    document.getElementById('qtdQuestoes').innerHTML = quantidadeDeQuestoes

    preencherHTMLcomQuestaoAtual(0);

    btnProx.disabled = true;
  }

  let respostasQuiz = [];

  document.querySelectorAll('input[name="option"]').forEach(radio => {
    radio.onclick = () => {
      const alternativa = radio.value;
      const questaoAtual = listaDeQuestoes[numeroDaQuestaoAtual];
      let idResposta = null;
      if (alternativa === 'alternativaA') idResposta = questaoAtual.idAlternativaA;
      if (alternativa === 'alternativaB') idResposta = questaoAtual.idAlternativaB;
      if (alternativa === 'alternativaC') idResposta = questaoAtual.idAlternativaC;
      if (alternativa === 'alternativaD') idResposta = questaoAtual.idAlternativaD;

      respostasQuiz[numeroDaQuestaoAtual] = {
        idPergunta: questaoAtual.id,
        idResposta: idResposta
      };

      document.querySelectorAll('.opcao').forEach(label => label.classList.remove('selecionado'));
      document.getElementById('label' + alternativa.charAt(0).toUpperCase() + alternativa.slice(1)).classList.add('selecionado');

      btnProx.disabled = false;
    }
  });

  function preencherHTMLcomQuestaoAtual(index) {
    habilitarAlternativas(true);
    const questaoAtual = listaDeQuestoes[index];
    numeroDaQuestaoAtual = index;

    document.getElementById("spanNumeroDaQuestaoAtual").innerHTML = index + 1;
    document.getElementById("spanNumeroDaQuestaoAtual2").innerHTML = index + 1;
    document.getElementById("spanQuestaoExibida").innerHTML = questaoAtual.pergunta;

    document.getElementById("labelAlternativaA").innerText = questaoAtual.alternativaA;
    document.getElementById("labelAlternativaB").innerText = questaoAtual.alternativaB;
    document.getElementById("labelAlternativaC").innerText = questaoAtual.alternativaC || '';
    document.getElementById("labelAlternativaD").innerText = questaoAtual.alternativaD || '';
  }

  function habilitarAlternativas(enable) {
    document.querySelectorAll('input[name="option"]').forEach(radio => {
      radio.disabled = !enable;
    });
  }

  function avancar() {
    document.querySelector(".btn-proximo").disabled = true;

    limparCoresBackgroundOpcoes();

    if (numeroDaQuestaoAtual < quantidadeDeQuestoes - 1) {
      numeroDaQuestaoAtual++;
      preencherHTMLcomQuestaoAtual(numeroDaQuestaoAtual)
    } else {
      finalizarJogo();
    }

    document.querySelectorAll('input[name="option"]').forEach(radio => {
      radio.checked = false;
    });
  }

  function limparCoresBackgroundOpcoes() {
    const botoes = document.querySelectorAll(".opcao");
    botoes.forEach(btn => {
      btn.classList.remove("selecionado");
    });
  }

  function finalizarJogo() {
    salvar();

    setTimeout(() => {
      alert("Quiz finalizado! Suas respostas foram salvas.");
      window.location.href = "dashboard.html";
    }, 1000);
  }

  function salvar() {
    const idUsuario = sessionStorage.ID_USUARIO;

    fetch("/respostas/salvarRespostas", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idUsuario: idUsuario,
        respostas: respostasQuiz
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
    return false;
  }
</script>